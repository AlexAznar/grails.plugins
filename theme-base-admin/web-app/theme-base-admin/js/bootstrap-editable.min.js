/*! Bootstrap Editable - v1.0.5 
* In-place editing with Bootstrap Form and Popover
* https://github.com/vitalets/bootstrap-editable

* Copyright (c) 2012 Vitaliy Potapov; Licensed MIT, GPL */
(function(a){function c(a){return this.each(function(b,c){if(c.setSelectionRange)c.setSelectionRange(a,a);else if(c.createTextRange){var d=c.createTextRange();d.collapse(!0),d.moveEnd("character",a),d.moveStart("character",a),d.select()}}),this}function d(a,b){if(typeof a=="string"&&a.length&&a.match(/^\{.*\}$/))if(b)try{a=(new Function("return "+a))()}catch(c){}finally{return a}else a=(new Function("return "+a))();return a}var b=function(b,c){this.$element=a(b),c&&c.placement&&!this.$element.data("placement")&&this.$element.attr("data-placement",c.placement),c&&c.title&&!this.$element.data("original-title")&&this.$element.attr("data-original-title",c.title);var d=this.$element.data().type||c&&c.type||a.fn.editable.defaults.type,e=a.fn.editable.types[d]?a.fn.editable.types[d]:{};this.settings=a.extend({},a.fn.editable.defaults,a.fn.editable.types.defaults,e,c,this.$element.data()),this.name=this.$element.attr("name")||this.$element.attr("id")||this.settings.name,this.name||a.error("You should define name (or id) for Editable element"),typeof this.settings.validate=="object"&&this.name in this.settings.validate&&(this.settings.validate=this.settings.validate[this.name]),typeof this.settings.init=="function"&&this.settings.init.call(this,c),this.settings.toggle?(this.$toggle=a(this.settings.toggle),this.$toggle.parent().length||this.$element.after(this.$toggle),this.$element.attr("tabindex",-1)):this.$toggle=this.$element,this.errorOnRender=!1,this.$element.addClass("editable"),this.$toggle.on("click",a.proxy(this.click,this)),this.settings.value===undefined||this.settings.value===null?this.settings.setValueByText.call(this):this.value=this.settings.value,this.lastSavedValue=this.value,this.settings.autotext&&this.settings.setTextByValue.call(this),this.handleEmpty()};b.prototype={constructor:b,click:function(a){a.stopPropagation(),a.preventDefault(),this.$element.data("popover")||this.$element.popover({trigger:"manual",placement:"top",content:this.settings.loading,template:'<div class="popover"><div class="arrow"></div><div class="popover-inner '+this.settings.popoverClass+'"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'}),this.$element.data("popover").tip().is(":visible")?this.hide():this.startShow()},startShow:function(){a(".popover").find("form").find("button.editable-cancel").click(),this.$element.popover("show"),this.$element.addClass("editable-open"),this.errorOnRender=!1,this.settings.renderInput.call(this)},endShow:function(){var b=this.$element.data("popover").tip();this.$content=a(this.settings.formTemplate),this.$content.find("div.control-group").prepend(this.$input),b.find(".popover-content p").append(this.$content),this.errorOnRender?(this.$input.attr("disabled",!0),b.find("button.btn-primary").attr("disabled",!0),b.find("form").submit(function(){return!1}),this.enableContent(this.errorOnRender)):(this.$input.removeAttr("disabled"),b.find("button.btn-primary").removeAttr("disabled"),b.find("form").submit(a.proxy(this.submit,this)),this.enableContent(),this.settings.setInputValue.call(this)),b.find("button.editable-cancel").click(a.proxy(this.hide,this));var c=this;a(document).on("keyup.editable",function(a){a.which===27&&(a.stopPropagation(),c.hide())})},submit:function(b){b.stopPropagation(),b.preventDefault();var c,e,f,g=this,h=this.settings.getInputValue.call(this);if(c=this.validate(h)){this.enableContent(c),(this.settings.type==="text"||this.settings.type==="textarea")&&this.$input.focus();return}typeof this.settings.pk=="function"?e=this.settings.pk.call(this.$element):typeof this.settings.pk=="string"&&a(this.settings.pk).length===1&&a(this.settings.pk).parent().length?e=a(this.settings.pk).text():e=this.settings.pk;var i=this.settings.url!==undefined&&(this.settings.send==="always"||this.settings.send==="ifpk"&&e);if(i){this.settings.params=d(this.settings.params,!0),f=typeof this.settings.params=="string"?{params:this.settings.params}:a.extend({},this.settings.params),f.value=h,this.enableLoading(),e&&(f.pk=e),this.settings.name&&(f.name=this.settings.name);var j=typeof this.settings.url=="function"?this.settings.url.call(this):this.settings.url;a.ajax({url:j,data:f,type:"post",dataType:"json",success:function(a){typeof g.settings.success=="function"&&(c=g.settings.success.apply(g,arguments))?g.enableContent(c):(g.value=h,g.settings.setTextByValue.call(g),g.markAsSaved(),g.handleEmpty(),g.hide())},error:function(a){var b=typeof g.settings.error=="function"?g.settings.error.apply(g,arguments):null;g.enableContent(b||a.statusText)}})}else this.value=h,this.settings.setTextByValue.call(this),this.markAsUnsaved(),this.handleEmpty(),this.hide()},hide:function(){this.$element.popover("hide"),this.$element.removeClass("editable-open"),a(document).off("keyup.editable"),(this.settings.enablefocus||this.$element.get(0)!==this.$toggle.get(0))&&this.$toggle.focus()},enableContent:function(a){a!==undefined&&a.length>0?this.$content.find("div.control-group").addClass("error").find("span.help-block").text(a):this.$content.find("div.control-group").removeClass("error").find("span.help-block").text(""),this.$content.show(),this.$element.data("popover").tip().find(".editable-loading").hide()},enableLoading:function(){this.$content.hide(),this.$element.data("popover").tip().find(".editable-loading").show()},handleEmpty:function(){this.$element.text()===""?this.$element.addClass("editable-empty").text(this.settings.emptytext):this.$element.removeClass("editable-empty")},validate:function(a){a===undefined&&(a=this.value);if(typeof this.settings.validate=="function")return this.settings.validate.call(this,a)},markAsUnsaved:function(){this.value!==this.lastSavedValue?this.$element.addClass("editable-changed"):this.$element.removeClass("editable-changed")},markAsSaved:function(){this.lastSavedValue=this.value,this.$element.removeClass("editable-changed")}},a.fn.editable=function(c){var d={};switch(c){case"validate":return this.each(function(){var b=a(this),c=b.data("editable"),e;c&&(e=c.validate())&&(d[c.name]=e)}),d;case"getValue":return this.each(function(){var b=a(this),c=b.data("editable");c&&(d[c.name]=c.value)}),d}return this.each(function(){var d=a(this),e=d.data("editable"),f=typeof c=="object"&&c;e||d.data("editable",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.editable.Constructor=b,a.fn.editable.defaults={url:null,type:"text",name:null,pk:null,value:null,emptytext:"Empty",params:null,send:"ifpk",autotext:!1,enablefocus:!0,popoverClass:"editable-popover-text",formTemplate:'<form class="form-inline" style="margin-bottom: 0" autocomplete="off"><div class="control-group">&nbsp;<button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i></button>&nbsp;<button type="button" class="btn editable-cancel"><i class="icon-ban-circle"></i></button><span class="help-block" style="clear: both"></span></div></form>',loading:'<div class="editable-loading"></div>',validate:function(a){},success:function(a){},error:function(a){}},a.fn.editable.types={defaults:{renderInput:function(){this.$input=a(this.settings.template),this.endShow()},setInputValue:function(){this.$input.val(this.value),this.$input.focus()},getInputValue:function(){return this.$input.val()},setTextByValue:function(){this.$element.text(this.value)},setValueByText:function(){this.value=this.$element.text()}},text:{template:'<input type="text" class="span2">',setInputValue:function(){this.$input.val(this.value),c.call(this.$input,this.$input.val().length),this.$input.focus()}},select:{template:'<select class="span2"></select>',source:null,prepend:!1,onSourceReady:function(b,c){try{this.settings.source=d(this.settings.source,!1)}catch(e){c.call(this);return}if(typeof this.settings.source=="string"){var f=this.settings.source+"-"+this.name,g=a(document).data(f);if(typeof g=="object"){this.settings.source=g,b.call(this);return}a.ajax({url:this.settings.source,type:"get",data:{name:this.name},dataType:"json",success:a.proxy(function(c){this.settings.source=this.settings.doPrepend.call(this,c),a(document).data(f,this.settings.source),b.call(this)},this),error:a.proxy(c,this)})}else this.settings.source=this.settings.doPrepend.call(this,this.settings.source),b.call(this)},doPrepend:function(b){return this.settings.prepend=d(this.settings.prepend,!0),typeof this.settings.prepend=="string"?a.extend({},{"":this.settings.prepend},b):typeof this.settings.prepend=="object"?a.extend({},this.settings.prepend,b):b},renderInput:function(){this.$input=a(this.settings.template),this.settings.onSourceReady.call(this,function(){typeof this.settings.source=="object"&&this.settings.source!=null&&a.each(this.settings.source,a.proxy(function(b,c){this.$input.append(a("<option>",{value:b}).text(c))},this)),this.endShow()},function(){this.errorOnRender="Error when loading options",this.endShow()})},setValueByText:function(){this.value=null},setTextByValue:function(){this.settings.onSourceReady.call(this,function(){this.value in this.settings.source?this.$element.text(this.settings.source[this.value]):this.$element.text("Undefined!")},function(){this.$element.text("Error!")})}},textarea:{template:'<textarea class="span4" rows="8"></textarea>',popoverClass:"editable-popover-textarea",setInputValue:function(){this.$input.val(this.value),c.apply(this.$input,[this.$input.val().length]),this.$input.focus()},setValueByText:function(){var b=this.$element.html().split(/<br\s*\/?>/i);for(var c=0;c<b.length;c++)b[c]=a("<div>").html(b[c]).text();this.value=b.join("\n")},setTextByValue:function(){var b=this.value.split("\n");for(var c=0;c<b.length;c++)b[c]=a("<div>").text(b[c]).html();var d=b.join("<br>");this.$element.html(d)}},date:{template:'<div style="float: left"></div>',popoverClass:"editable-popover-date",datepicker:{dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0},init:function(b){var c=this.settings.format;b=b?b:{},c&&(b.datepicker=a.extend({},b.datepicker,{dateFormat:c})),b.datepicker&&(this.settings.datepicker=a.extend({},a.fn.editable.types.date.datepicker,b.datepicker))},renderInput:function(){this.$input=a(this.settings.template),this.$input.datepicker(this.settings.datepicker),this.endShow()},setInputValue:function(){this.$input.datepicker("setDate",this.value)}}}})(window.jQuery);